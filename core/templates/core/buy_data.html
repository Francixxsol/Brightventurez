{% extends "core/base.html" %}
{% block content %}
<section class="card">
  <h2>Buy Data</h2>
  <p><strong>Wallet Balance:</strong> ₦{{ wallet.balance }}</p>

  <form method="POST" id="buyDataForm">
    {% csrf_token %}

    <label>Select Network</label>
    <select name="network" id="network" required>
      <option value="">-- Select Network --</option>
      <option value="MTN">MTN</option>
      <option value="AIRTEL">AIRTEL</option>
      <option value="GLO">GLO</option>
      <option value="9MOBILE">9MOBILE</option>
    </select>

    <label>Select Data Type</label>
    <select name="data_type" id="data_type" required>
      <option value="">-- Select Data Type --</option>
      <option value="SME">SME</option>
      <option value="SME2">SME2</option>
      <option value="GIFTING">GIFTING</option>
      <option value="AWUF">AWUF</option>
    </select>

    <label>Select Plan</label>
    <select name="plan_id" id="plan_id" required>
      <option value="">-- Select Plan --</option>
    </select>

    <label>Enter Phone:</label>
    <input type="text" name="phone" placeholder="080..." required>

    <button type="submit" id="buyButton">Buy Data</button>
  </form>
</section>

<!-- ✅ Styles -->
<style>
  .spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid #fff;
    border-radius: 50%;
    border-top-color: transparent;
    margin-left: 6px;
    animation: spin 0.8s linear infinite;
    vertical-align: middle;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  button[disabled] {
    background-color: #ccc;
    cursor: not-allowed;
  }

  /* === Toast Notification === */
  .toast {
    position: fixed;
    left: 50%;
    bottom: -100px;
    transform: translateX(-50%);
    background: #fff;
    color: #000;
    padding: 16px 22px;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.25);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    min-width: 280px;
    z-index: 9999;
    animation: slideUp 0.5s ease forwards;
  }
  .toast.success { border-left: 6px solid #28a745; }
  .toast.error { border-left: 6px solid #dc3545; }

  .toast button {
    background: none;
    border: none;
    color: #888;
    font-size: 18px;
    cursor: pointer;
    padding: 0;
  }

  @keyframes slideUp {
    from { bottom: -100px; opacity: 0; }
    to { bottom: 30px; opacity: 1; }
  }

  @keyframes slideDown {
    from { bottom: 30px; opacity: 1; }
    to { bottom: -100px; opacity: 0; }
  }
</style>

<!-- ✅ Script -->
<script>
  const networkSelect = document.getElementById("network");
  const dataTypeSelect = document.getElementById("data_type");
  const planSelect = document.getElementById("plan_id");
  const buyButton = document.getElementById("buyButton");
  const form = document.getElementById("buyDataForm");

  // Reset plan dropdown
  function resetPlanSelect(message = "-- Select Plan --") {
    planSelect.innerHTML = "";
    const defaultOpt = document.createElement("option");
    defaultOpt.textContent = message;
    defaultOpt.disabled = message !== "-- Select Plan --";
    defaultOpt.selected = true;
    planSelect.appendChild(defaultOpt);
  }

  // Fetch plans dynamically
  function loadPlans() {
    const network = networkSelect.value;
    const dataType = dataTypeSelect.value;

    resetPlanSelect("Loading plans...");

    if (!network || !dataType) {
      resetPlanSelect("-- Select Plan --");
      return;
    }

    fetch(`/api/data/plans?network=${network}&data_type=${dataType}`)
      .then(res => res.json())
      .then(data => {
        planSelect.innerHTML = "";
        if (data.plans && data.plans.length > 0) {
          data.plans.forEach(p => {
            const opt = document.createElement("option");
            opt.value = p.id;
            opt.textContent = `${p.plan_name} - ${p.size} - ₦${p.selling_price}`;
            planSelect.appendChild(opt);
          });
        } else {
          resetPlanSelect("No plans available");
        }
      })
      .catch(() => resetPlanSelect("Error loading plans"));
  }

  networkSelect.addEventListener("change", loadPlans);
  dataTypeSelect.addEventListener("change", loadPlans);

  // ✅ Toast Notification
  function showToast(type, message) {
    const toast = document.createElement("div");
    toast.className = `toast ${type}`;
    toast.innerHTML = `
      <span>${type === "success" ? "✅" : "❌"} ${message}</span>
      <button>&times;</button>
    `;

    document.body.appendChild(toast);

    const closeBtn = toast.querySelector("button");
    const removeToast = () => {
      toast.style.animation = "slideDown 0.5s ease forwards";
      setTimeout(() => toast.remove(), 500);
    };

    closeBtn.onclick = removeToast;
    setTimeout(removeToast, 4000);
  }

  // ✅ Handle form submission
  form.addEventListener("submit", function(e) {
    e.preventDefault();
    buyButton.disabled = true;
    buyButton.innerHTML = 'Processing <span class="spinner"></span>';

    const formData = new FormData(form);

    fetch(form.action || window.location.href, {
      method: "POST",
      body: formData,
    })
      .then(res => res.json())
      .then(response => {
        if (response.success) {
          showToast("success", "Data purchase successful!");
          form.reset();
          resetPlanSelect("-- Select Plan --");
        } else {
          showToast("error", response.message || "Transaction failed!");
        }
      })
      .catch(() => showToast("error", "An error occurred! Try again."))
      .finally(() => {
        buyButton.disabled = false;
        buyButton.innerHTML = "Buy Data";
      });
  });
</script>
{% endblock %}
