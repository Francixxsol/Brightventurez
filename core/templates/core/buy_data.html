{% extends "core/base.html" %}
{% block content %}

<section class="card">
  <h2>Buy Data</h2>

  <p class="wallet">
    Wallet Balance: <strong>₦ {{ wallet.balance|floatformat:2 }}</strong>
  </p>

  {% if messages %}
    {% for message in messages %}
      <div class="alert {{ message.tags }}">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}

  <form method="POST" action="{% url 'core:buy_data' %}">
    {% csrf_token %}

<label>Select Network</label>
<select name="network" id="network" required>
    <option value="">-- Select Network --</option>
    <option value="01">MTN</option>
    <option value="02">AIRTEL</option>
    <option value="03">GLO</option>
    <option value="04">9MOBILE</option>
</select>

<label>Select Data Type</label>
<select name="data_type" id="data_type" required>
    <option value="">-- Select Data Type --</option>
    <option value="sme">SME</option>
    <option value="cg">Corporate</option>
    <option value="gifting">Gifting</option>
    <option value="cglite">CGlite</option>
</select>

<label>Select Plan</label>
<select name="plan_id" id="plan_id" required>
    <option value="">-- Select Plan --</option>
</select>

<div id="plan-info" style="margin-top:10px;">
    <!-- Live plan info will appear here -->
</div>

<label>Enter Phone</label>
<input type="text" name="phone" placeholder="080..." required>

<button type="submit">Buy Data</button>
  </form>
</section>

<style>
.card{
  max-width:420px;
  margin:30px auto;
  padding:20px;
  background:#1a1b3a;
  color:#fff;
  border-radius:16px;
}
.card h2{text-align:center;margin-bottom:10px;}
.wallet{text-align:center;margin-bottom:15px;}
label{display:block;margin-top:12px;font-size:14px;}
select,input{
  width:100%;
  padding:10px;
  border-radius:8px;
  border:none;
  margin-top:6px;
}
button{
  margin-top:18px;
  width:100%;
  padding:12px;
  background:#4b6cb7;
  border:none;
  border-radius:10px;
  color:#fff;
  font-weight:600;
}
.alert{
  padding:10px;
  border-radius:8px;
  margin-bottom:10px;
  font-weight:600;
}
.alert.success{background:#0abf53;}
.alert.error{background:#d9534f;}
.alert.warning{background:#f0a500;}
</style>

<script>
const network = document.getElementById("network");
const dataType = document.getElementById("data_type");
const planSelect = document.getElementById("plan_id");

function loadPlans(){
  if(!network.value || !dataType.value) return;

  planSelect.innerHTML = "<option>Loading...</option>";

  fetch(`/get_plans/?network=${network.value}&data_type=${dataType.value}`)
    .then(res => res.json())
    .then(data => {
      planSelect.innerHTML = "";
      if(data.plans.length){
        data.plans.forEach(p => {
          const opt = document.createElement("option");
          opt.value = p.id;
          opt.textContent = `${p.plan_name} (${p.duration || ""}) – ₦${p.my_price}`;
          planSelect.appendChild(opt);
        });
      }else{
        planSelect.innerHTML = "<option>No plans available</option>";
      }
    });
}

network.addEventListener("change", loadPlans);
dataType.addEventListener("change", loadPlans);
</script>

{% endblock %}
